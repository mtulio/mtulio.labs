Description: |
  Deploy Proxy Cluster with custom VPC PrivateLink Service.
  Resources deployed:
  - Network Load Balancer with listener 3389
  - Target Group with proxy servers registred with InstanceId
  - AutoScalingGroup launching new instances when high requests
  Optional resources:
  - Predictive scaling 
  - Custom PrivateLink service
AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  NamePrefix:
    AllowedPattern: ^([a-zA-Z][a-zA-Z0-9\-]{0,26})$
    MaxLength: 26
    MinLength: 1
    ConstraintDescription: Cluster name must be alphanumeric, start with a letter, and have a maximum of 27 characters.
    Description: A short, representative cluster name to use for host names and other identifying names.
    Type: String

  TemplatesBaseURL:
    Type: String
    Description: Choose 2 Subnets to create Load balancer and ASG

  VpcCidr:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-4]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-24.
    Default: 10.0.0.0/16
    Description: CIDR block for VPC.
    Type: String

  BaseAmiId:
    Description: Base AMI ID to provision the EC2 for services (proxy and bastion).
    Type: String
    AllowedPattern: ^(?:(?:ami)(?:-[a-zA-Z0-9]+)?\b|(?:[0-9]{1,3}\.){3}[0-9]{1,3})$
    ConstraintDescription: Subnet ID must be with valid name, starting with ami-.*.

  ProxyUserData:
    Description: Proxy User Data
    Type: String

  BastinoUserData:
    Description: Proxy User Data
    Type: String

  ProxyDnsHostedZoneId:
    Description: DNS Hosted Zone ID to create the DNS Record.
    Type: String
    Default: "0"

  ProxyDnsRecordName:
    Description: DNS Record Name to create CNAME for Load Balancer DNS.
    Type: String
    Default: "0"

Resources:
  #
  # Network Setup
  #
  #> Run Nested ChangeSet (Nested from Nested)
  Network:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join ['/', [!Ref TemplatesBaseURL, "stack_ocp_private-vpc_ipv4_public_blackhole.yaml"]]
      TimeoutInMinutes: 5
      Parameters:
        NamePrefix: !Ref NamePrefix
        VpcCidr: !Ref VpcCidr
        TemplatesBaseURL: !Ref TemplatesBaseURL

  #
  # Proxy Service
  #
  # Create Proxy Config
  # Create Proxy Instance
  ProxyNode:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join ['/', [!Ref TemplatesBaseURL, "stack_ocp_private-node_proxy.yaml"]]
      TimeoutInMinutes: 10
      Parameters:
        NamePrefix: !Join ['-', [!Ref NamePrefix, "proxy"]]
        TemplatesBaseURL: !Ref TemplatesBaseURL
        VpcCidr: !Ref VpcCidr
        VpcId: !GetAtt 'Network.Outputs.VpcId'
        AmiId: !Ref BaseAmiId
        SubnetId: !Select [0, !Split [",", !GetAtt 'Network.Outputs.PublicSubnetIds']]
        UserData: !Ref ProxyUserData
        DnsHostedZoneId: !Ref ProxyDnsHostedZoneId
        DnsRecordName: !Ref ProxyDnsRecordName

  #
  # Bastion host
  #
  BastionNode:
    Type: AWS::CloudFormation::Stack
    DependsOn: [ProxyNode]
    Properties:
      TemplateURL: !Join ['/', [!Ref TemplatesBaseURL, "stack_ocp_private-node_bastion.yaml"]]
      TimeoutInMinutes: 5
      Parameters:
        NamePrefix: !Ref NamePrefix
        TemplatesBaseURL: !Ref TemplatesBaseURL
        VpcCidr: !Ref VpcCidr
        VpcId: !GetAtt 'Network.Outputs.VpcId'
        AmiId: !Ref BaseAmiId
        UserData: !Ref BastinoUserData
        SubnetId: !Select [0, !Split [",", !GetAtt 'Network.Outputs.PrivateSubnetIds']]

Outputs:
  VpcId:
    Description: VPC ID
    Value: !GetAtt 'Network.Outputs.VpcId'
  # SubnetsId
  # RouteTables
  # Proxy DNS/LB address
  # Proxy LB ARN
  # Bastion InstanceId
  BastionNodeInstanceId:
    Description: Bastion Host Instance ID.
    Value: !GetAtt 'BastionNode.Outputs.InstanceId'
  # Bastion CMD: session fwd bastion
  BastionPrivateIP:
    Description: Bastion Host Instance ID.
    Value: !GetAtt 'BastionNode.Outputs.PrivateIp'
  ProxyLoadBalancerDnsAddress:
    Description: Load Balancer Address for the Proxy service.
    Value: !Ref ProxyDnsRecordName

  # Bastion CMD: session fwd API-int
  # Bastion CMD: session fwd bootstrap

  # ProxyInstanceId:
  #   Description: Proxy Instance ID.
  #   Value: !GetAtt 'ProxyInstance.Outputs.InstanceId'
  # ProxyPrivateIp:
  #   Description: Proxy Private IP.
  #   Value: !GetAtt 'ProxyInstance.Outputs.PrivateIp'
  # LoadBalancerArn:
  #   Description: Load Balancer.
  #   Value: !Ref LoadBalancer
  # LoadBalancerDNS:
  #   Description: Load Balancer DNS.
  #   Value: !GetAtt LoadBalancer.DNSName
