---
- name: OpenShift Config Load
  hosts: localhost
  connection: local

  vars_prompt:
    - name: install_dir
      prompt: What is the Installation Directory?
      private: no

  tasks:
    - name: OpenShift Config Load | Get Installer data
      set_fact:
          ocp_installer_state: "{{ lookup('file', install_dir + '/.openshift_install_state.json') }}"
          ocp_installer_metadata: "{{ lookup('file', install_dir + '/metadata.json') }}"
          ocp_ignition_bootstrap: "{{ lookup('file', install_dir + '/bootstrap.ign') }}"
      no_log: yes

    - name: OpenShift Config Load | Set Defaults
      set_fact:
          ocp_install_image: "{{ ocp_installer_state[\"*rhcos.Image\"] }}"
          ocp_install_infraID: "{{ ocp_installer_metadata.infraID }}"
          ocp_install_clusterName: "{{ ocp_installer_metadata.clusterName }}"
          ocp_config_baseDomain: "{{ ocp_installer_state[\"*installconfig.InstallConfig\"][\"config\"][\"baseDomain\"] }}"
          ocp_cluster_tags: {}
          ocp_config_region: "{{ lookup('env', 'CONFIG_REGION') }}"

    - name: OpenShift Config Load | Set Default tags
      set_fact:
          ocp_cluster_tags: "{% set x=ocp_cluster_tags.__setitem__('kubernetes.io/cluster/'+ocp_install_infraID, 'owned' ) %}{{ ocp_cluster_tags }}"

    - name: OpenShift Config Load | Set Default Resource Names
      set_fact:
          ocp_iam_profile_bootstrap: "{{ ocp_install_infraID }}-instance-bootstrap"
          ocp_iam_profile_controlplane: "{{ ocp_install_infraID }}-instance-controlplane"
          ocp_iam_profile_compute: "{{ ocp_install_infraID }}-instance-compute"

    - name: Load cluster_state config
      set_fact:
        cluster_state: "{{ lookup('file', install_dir + '/cluster_state.json', errors='ignore') }}"

    - name: Set cluster_state initial config
      set_fact:
        cluster_state:
          cluster_name: "{{ ocp_installer_metadata.clusterName }}"
          cluster_id: "{{ ocp_installer_metadata.clusterID }}"
          infra_id: "{{ ocp_install_infraID }}"
          tags: "{{ ocp_cluster_tags }}"
          region: "{{ ocp_config_region | d('NA') }}"
          platform:
            provider: "{{ provider | d('NA') }}"
            integratoin: "{{ config_platform | d('none') }}"
          zones:
            base: "{{ ocp_config_baseDomain }}"
            base_id: ''
            cluster: "{{ ocp_install_clusterName }}.{{ ocp_config_baseDomain }}"
            cluster_id: ''
            registers: []
          network:
            vpc_id: ''
            subnets: []
          loadbalancers: {}
          compute:
            image_id: "{{ custom_image_id | d(ocp_install_image) }}"
            iam_profile_bootstrap: "{{ ocp_install_infraID }}-instance-bootstrap"
            iam_profile_compute: "{{ ocp_install_infraID }}-instance-compute"
            iam_profile_controlplane: "{{ ocp_install_infraID }}-instance-controlPlane"
          certificates:
            root_ca: "{{ ocp_ignition_bootstrap | json_query(query_root_ca) | join('') }}"
      when: cluster_state | length <= 0
      vars:
        query_root_ca: "storage.files[?path=='/opt/openshift/tls/root-ca.crt'].contents.source"

    - debug: var=ocp_install_image
    - debug: var=ocp_install_infraID
