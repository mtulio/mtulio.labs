---
openshift_prefix: "{{ cluster_state.infra_id }}"
openshift_bootstrap_bucket: "{{ openshift_prefix }}"

openshift_instance_type: s-4vcpu-8gb
openshift_image_id: "fedora-coreos-34.20210626.3.1-digitalocean.x86_64.qcow2.gz"
openshift_vpc_name: "{{ openshift_prefix }}-vpc"
openshift_security_groups:
  - "{{ openshift_prefix }}-bootstrap-sg"
  - "{{ openshift_prefix }}-controlplane-sg"
openshift_tags: "{{ cluster_state.tags }}"

openshift_userdata:
  config_source: "{{ setup_bootstrap_ign_spaces_url }}"

_def:
  name: "{{ openshift_prefix }}-bootstrap"
  region: "{{ cluster_state.region }}"
  project: "{{ cluster_state.infra_id }}"
  image_id: "{{ openshift_image_id }}"
  instance_type: "{{ openshift_instance_type }}"
  state: present
  vpc_name: "{{ openshift_vpc_name }}"
  wait: yes
  wait_timeout: 500

compute_resources:
    # Module 'machine' options:
    - provider: do
      type: machine
      name: "{{ _def.name }}"
      state: "{{ _def.state }}"
      #filters:
      #  tag:Name: "{{ _def.name }}"
      #  instance-state-name: running
      #tags: "{% set x=cluster_state.tags.__setitem__('Name', _def.name ) %}{{ cluster_state.tags }}"
      #security_groups: "{{ _def.security_groups }}"
      #volumes: "{{ _def.volumes | d([]) }}"
      user_data: "{{ lookup('template', 'ocp-bootstrap-user-data.j2') |to_nice_json | string }}"
      vpc_name: "{{ _def.vpc_name }}"
      wait: "{{ _def.wait }}"
      wait_timeout: "{{ _def.wait_timeout }}"

      #firewall: "{{ _def.firewall }}"
      image_name: "{{ _def.image_id }}"
      #ipv6: no
      #monitoring: no
      private_networking: yes
      project_name: "{{ _def.project }}"
      region: "{{ _def.region }}"
      size: "{{ _def.instance_type }}"
      #sleep_interval: 
      ssh_key:
        name: "{{ _def.project }}"
        pub_key: "{{ lookup('ansible.builtin.env', 'CONFIG_SSH_KEY') }}"
      #tags: 
      #user_data: 
      #volumes:

      register_resources:
        - service: loadbalancer
          service_type: lb
          resource_name: "{{ openshift_prefix}}-ext"
          resource_type: ip
          #resource_id: private_ip
