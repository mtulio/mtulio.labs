---

#AWS: https://docs.ansible.com/ansible/latest/collections/community/aws/elb_target_group_module.html
cloud_loadbalancer_targets:
  - name: "{{ cluster_state.infra_id }}-aext"
    provider: aws
    protocol: tcp
    port: 6443
    target_type: ip
    vpc_name: ocp-vpc-use1
    health_check_protocol: https
    health_check_path: /readyz
    health_check_port: 6443
    successful_response_codes: "200-399"
    health_check_interval: 10
    #health_check_timeout: 2
    healthy_threshold_count: 2
    unhealthy_threshold_count: 2
    state: present
    tags: {}

  - name: "{{ cluster_state.infra_id }}-aint"
    provider: aws
    protocol: tcp
    port: 6443
    target_type: ip
    vpc_name: ocp-vpc-use1
    health_check_protocol: https
    health_check_path: /readyz
    health_check_port: 6443
    successful_response_codes: "200-399"
    health_check_interval: 10
    #health_check_timeout: 2
    healthy_threshold_count: 2
    unhealthy_threshold_count: 2
    state: present

  - name: "{{ cluster_state.infra_id }}-sint"
    provider: aws
    protocol: tcp
    port: 22623
    target_type: ip
    vpc_name: ocp-vpc-use1
    health_check_protocol: https
    health_check_path: /healthz
    health_check_port: 22623
    successful_response_codes: "200-399"
    health_check_interval: 10
    #health_check_timeout: 2
    healthy_threshold_count: 2
    unhealthy_threshold_count: 2
    state: present

# AWS: https://docs.ansible.com/ansible/latest/collections/community/aws/elb_network_lb_module.html
cloud_loadbalancers:
  - name: "{{ cluster_state.infra_id }}-ext"
    openshift_id: public
    provider: aws
    type: network
    scheme: internet-facing
    state: present
    tags: {}
    #subnet_mappings:
    #subnets: []
    subnets_discovery: yes
    vpc_name: ocp-vpc-use1
    subnets_names:
      - ocp-net-public-use1-1a
      - ocp-net-public-use1-1b
      - ocp-net-public-use1-1c
    cross_zone_load_balancing: yes
    ip_address_type: ipv4
    listeners:
      - Protocol: TCP
        Port: 6443
        DefaultActions:
          - Type: forward
            TargetGroupName: "{{ cluster_state.infra_id }}-aext"
    register_dns:
      - zone: "{{ cluster_state.zones.base }}"
        record: "api.{{ cluster_state.zones.cluster }}"
        overwrite: yes
      - zone: "{{ cluster_state.zones.cluster }}"
        record: "api.{{ cluster_state.zones.cluster }}"
        private_zone: yes
        overwrite: yes

  - name: "{{ cluster_state.infra_id }}-int"
    openshift_id: private
    provider: aws
    type: network
    scheme: internal
    state: present
    tags: "{{ cluster_state.tags }}"
    #subnet_mappings:
    #subnets: []
    subnets_discovery: yes
    vpc_name: ocp-vpc-use1
    subnets_names:
      - ocp-net-private-use1-1a
      - ocp-net-private-use1-1b
      - ocp-net-private-use1-1c
    cross_zone_load_balancing: yes
    ip_address_type: ipv4
    listeners:
      - Protocol: TCP
        Port: 6443
        DefaultActions:
          - Type: forward
            TargetGroupName: "{{ cluster_state.infra_id }}-aint"
      - Protocol: TCP
        Port: 22623
        DefaultActions:
          - Type: forward
            TargetGroupName: "{{ cluster_state.infra_id }}-sint"
    register_dns:
      - zone: "{{ cluster_state.zones.base }}"
        record: "api-int.{{ cluster_state.zones.cluster }}"
        overwrite: yes
      - zone: "{{ cluster_state.zones.cluster }}"
        record: "api-int.{{ cluster_state.zones.cluster }}"
        private_zone: yes
        overwrite: yes
