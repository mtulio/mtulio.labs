---
- include: openshift_config_load.yaml

- name: OpenShift Bootstrap Setup
  hosts: localhost
  connection: local

  vars_files:
    - "vars/compute/ocp-bootstrap-{{ provider }}.yaml"

  vars_prompt:
    - name: install_dir
      prompt: What is the Installation Directory?
      private: no


  pre_tasks:

    - block:

        - name: Create Spaces when provider is DO
          community.digitalocean.digital_ocean_spaces:
            state: present
            name: "{{ openshift_bootstrap_bucket }}"
            #region: "{{ ocp_config_region }}"
            region: "{{ cluster_state.region }}"
          register: do_space
        - debug: var=do_space
        - set_fact:
            openshift_bootstrap_bucket_url: "{{ do_space.data.space.endpoint_url }}"

        - name: Upload bootstrap.ign
          amazon.aws.aws_s3:
            bucket: "{{ openshift_bootstrap_bucket }}"
            object: "/bootstrap.ign"
            src: "{{ install_dir + '/bootstrap.ign' }}"
            mode: put
            s3_url: "{{ openshift_bootstrap_bucket_url | d(omit) }}"
          register: s3_put

        - debug: var=s3_put

        - set_fact:
            setup_bootstrap_ign_spaces_url: "{{ s3_put.url }}"

      when: provider == 'do'

    - block:

      - name: Create bucket
        s3_bucket:
          name: "{{ openshift_bootstrap_bucket }}"
          state: present

      # TODO: Make it indepotent
      - name: Upload bootstrap.ign
        amazon.aws.aws_s3:
          bucket: "{{ openshift_bootstrap_bucket }}"
          object: "/bootstrap.ign"
          src: "{{ install_dir + '/bootstrap.ign' }}"
          mode: put
        register: s3_put

      - debug: var=s3_put

      when: provider == 'aws'
